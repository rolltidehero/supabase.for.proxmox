<html>

<body bgcolor="#2E3440">
    <!--StartFragment-->
    <p node="[object Object]" class="db--c-hfBFtD"
        style="box-sizing: inherit; margin: 0px 0px 6px; white-space: pre-wrap; word-break: break-word; color: rgb(221, 224, 199); font-family: Inter; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(25, 19, 58); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">
        Okay, I have gathered all the necessary code and information. I will now assemble the <code
            class="db--c-hMVyzS db--c-jHrvrQ"
            style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">prompt.md</code>
        file. This file will contain the project setup details, requirements, configurations, user guidelines, and the
        full code for the relevant files, allowing you to recreate the app's current state in a new Databutton session.
    </p>
    <p node="[object Object]" class="db--c-hfBFtD"
        style="box-sizing: inherit; margin: 0px 0px 6px; white-space: pre-wrap; word-break: break-word; color: rgb(221, 224, 199); font-family: Inter; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(25, 19, 58); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">
        Here is the content I will write to <code class="db--c-hMVyzS db--c-jHrvrQ"
            style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">prompt.md</code>:
    </p>
    <pre
        style="box-sizing: inherit; margin: 4px 0px; color: rgb(221, 224, 199); font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(25, 19, 58); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;"><div class="db--c-dhzjXW db--c-dhzjXW-kqFZpo-direction-vertical db--c-dhzjXW-igvqKzt-css" style="box-sizing: inherit; display: flex; flex-flow: column; position: relative; color: var(--db--colors-gray001); line-height: inherit; overflow: auto; border-radius: 6px; border: 1px solid var(--db--colors-gray003); margin-left: calc(var(--db---messagePadding)*-1); margin-right: calc(var(--db---messagePadding)*-1);"><pre class="PJLV PJLV-ihhUadU-css" style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; width: 393.96px; font-size: var(--db--fontSizes-1); border-radius: 6px; overflow-x: scroll; margin: 4px 0px;"><div class="db--c-hxIgPZ db--c-hxIgPZ-kInFMZ-theme-dark" style="box-sizing: inherit; display: flex; justify-content: space-between; align-items: center; padding: 4px; border-bottom: 1px solid var(--db--colors-gray004); background-color: rgb(13, 17, 23);"><button type="button" class="db--c-dsHufW" style="box-sizing: inherit; display: flex; gap: 4px; border: none; cursor: pointer; height: 18px; padding-right: 6px; background-color: transparent; color: var(--db--colors-gray001);"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 16 16" class="db--c-bHwuwj"><path stroke="currentColor" stroke-width="1.5" d="M13.016 10.331l1.382 2.57-2.482 1.535M11.084 9.814l-2.482 1.535 1.382 2.57"></path><path stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M11.5 8V6a1 1 0 00-1-1H5a1 1 0 00-1 1v5.5a1 1 0 001 1h1"></path><path stroke="currentColor" stroke-width="1.5" d="M9.5 5V3.5a1 1 0 00-1-1h-6a1 1 0 00-1 1v6a1 1 0 001 1H4"></path></svg>Copy snippet</button></div><code class="PJLV PJLV-igIoyjz-css language-markdown hljs" style="box-sizing: inherit; width: 393.96px; font-size: var(--db--fontSizes-1); border-radius: 6px; overflow-x: auto; padding: 1em; color: rgb(201, 209, 217); background: rgb(13, 17, 23); display: block;"><span class="hljs-section" style="box-sizing: inherit; color: rgb(31, 111, 235); font-weight: 700;"># Databutton Bootstrap Prompt for Live Asset Tracker Pro</span>

This prompt contains the necessary information and code to recreate the "Live Asset Tracker Pro" application in its current state within a new Databutton workspace.

<span class="hljs-section" style="box-sizing: inherit; color: rgb(31, 111, 235); font-weight: 700;">## Project Setup</span>

<span class="hljs-code" style="box-sizing: inherit; color: rgb(139, 148, 158);">```yaml
App Name: Live Asset Tracker Pro
Description: &gt;
  A financial asset tracker application featuring real-time price updates via WebSockets,
  portfolio management with performance tracking (1H, 1W, 1M), and historical data visualization placeholders.
Target Audience: Financial traders and investors
Preferred Platform: desktop
Preferred Theme: dark</span></code></pre>
    </div>
    </pre>
    <h2 level="2" node="[object Object]"
        class="db--c-vRzws db--c-vRzws-bjRkxR-weight-bold db--c-vRzws-byOZOm-color-dark db--c-vRzws-ifIGqR-css"
        style="box-sizing: inherit; margin-top: var(--db---headerSpacing); margin-right: 0px; margin-bottom: var(--db---headerSpacing); margin-left: 0px; font-weight: 600; font-size: var(--db---mediumFontSize); line-height: 16.1px; letter-spacing: normal; text-transform: none; font-family: Inter; text-rendering: optimizelegibility; color: rgb(221, 224, 199); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; orphans: 2; text-align: start; text-indent: 0px; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(25, 19, 58); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">
        Core Features (Current State)</h2>
    <ol depth="0" node="[object Object]" class="db--c-iXCqBp db--c-bFgTVy"
        style="box-sizing: inherit; width: 395.24px; margin: 6px 0px; padding: 0px; list-style-type: decimal; color: rgb(221, 224, 199); font-family: Inter; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(25, 19, 58); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">
        <li index="0" node="[object Object]" class="db--c-GvogP"
            style="box-sizing: inherit; margin: 0px 0px 6px 16px; padding-left: 8px;"><strong
                style="box-sizing: inherit; font-family: Inter; font-weight: 600;">Real-time Price
                Streaming:</strong><span> </span>Connects to backend WebSockets (<code class="db--c-hMVyzS db--c-jHrvrQ"
                style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">/ws/stocks</code>,<span> </span><code
                class="db--c-hMVyzS db--c-jHrvrQ"
                style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">/ws/crypto</code>)
            to receive and display live price updates for selected stocks (Polygon.io) and cryptocurrencies (Coinbase
            Advanced Trade API).</li>
        <li index="1" node="[object Object]" class="db--c-GvogP"
            style="box-sizing: inherit; margin: 0px 0px 6px 16px; padding-left: 8px;"><strong
                style="box-sizing: inherit; font-family: Inter; font-weight: 600;">Portfolio Management:</strong>
            <ul depth="1" node="[object Object]" class="db--c-iXCqBp db--c-jaoMDw"
                style="box-sizing: inherit; width: 371.24px; margin: 6px 0px; padding: 0px; list-style-type: disc;">
                <li index="0" node="[object Object]" class="db--c-GvogP"
                    style="box-sizing: inherit; margin: 0px 0px 6px 16px; padding-left: 8px;">Add assets (stocks/crypto)
                    with quantity and purchase details via the<span> </span><code class="db--c-hMVyzS db--c-jHrvrQ"
                        style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">PortfolioPage</code>.
                </li>
                <li index="1" node="[object Object]" class="db--c-GvogP"
                    style="box-sizing: inherit; margin: 0px 0px 6px 16px; padding-left: 8px;">View portfolio holdings,
                    including calculated current value, profit/loss, and performance metrics (1H, 1W, 1M), fetched from
                    the<span> </span><code class="db--c-hMVyzS db--c-jHrvrQ"
                        style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">/portfolio</code><span> </span>API
                    endpoint.</li>
            </ul>
        </li>
        <li index="2" node="[object Object]" class="db--c-GvogP"
            style="box-sizing: inherit; margin: 0px 0px 6px 16px; padding-left: 8px;"><strong
                style="box-sizing: inherit; font-family: Inter; font-weight: 600;">Live Prices
                Display:</strong><span> </span>The<span> </span><code class="db--c-hMVyzS db--c-jHrvrQ"
                style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">LivePricesPage</code><span> </span>shows
            a table (<code class="db--c-hMVyzS db--c-jHrvrQ"
                style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">AssetTable</code><span> </span>component)
            of assets with real-time price updates and visual indication of price changes (green for up, red for down).
            Placeholder columns exist for performance metrics (1H/24H/7D).</li>
        <li index="3" node="[object Object]" class="db--c-GvogP"
            style="box-sizing: inherit; margin: 0px 0px 6px 16px; padding-left: 8px;"><strong
                style="box-sizing: inherit; font-family: Inter; font-weight: 600;">Historical Data
                Backend:</strong><span> </span>An API endpoint (<code class="db--c-hMVyzS db--c-jHrvrQ"
                style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">/history</code>)
            exists to fetch historical data (using Marketstack for stocks, CoinGecko for crypto), primarily used by the
            portfolio backend to calculate performance.</li>
    </ol>
    <h2 level="2" node="[object Object]"
        class="db--c-vRzws db--c-vRzws-bjRkxR-weight-bold db--c-vRzws-byOZOm-color-dark db--c-vRzws-ifIGqR-css"
        style="box-sizing: inherit; margin-top: var(--db---headerSpacing); margin-right: 0px; margin-bottom: var(--db---headerSpacing); margin-left: 0px; font-weight: 600; font-size: var(--db---mediumFontSize); line-height: 16.1px; letter-spacing: normal; text-transform: none; font-family: Inter; text-rendering: optimizelegibility; color: rgb(221, 224, 199); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; orphans: 2; text-align: start; text-indent: 0px; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(25, 19, 58); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">
        Backend Implementation (FastAPI)</h2>
    <h3 level="3" node="[object Object]"
        class="db--c-bLFSMJ db--c-bLFSMJ-bjRkxR-weight-bold db--c-bLFSMJ-byOZOm-color-dark db--c-bLFSMJ-ifIGqR-css"
        style="box-sizing: inherit; margin-top: var(--db---headerSpacing); margin-right: 0px; margin-bottom: var(--db---headerSpacing); margin-left: 0px; font-weight: 600; font-size: var(--db---mediumFontSize); line-height: 16.1px; letter-spacing: normal; text-transform: none; font-family: Inter; text-rendering: optimizelegibility; color: rgb(221, 224, 199); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; orphans: 2; text-align: start; text-indent: 0px; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(25, 19, 58); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">
        Required Python Packages (<code class="db--c-hMVyzS db--c-jHrvrQ"
            style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">src/requirements.txt</code>)
    </h3>
    <pre
        style="box-sizing: inherit; margin: 4px 0px; color: rgb(221, 224, 199); font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(25, 19, 58); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;"><div class="db--c-dhzjXW db--c-dhzjXW-kqFZpo-direction-vertical db--c-dhzjXW-igvqKzt-css" style="box-sizing: inherit; display: flex; flex-flow: column; position: relative; color: var(--db--colors-gray001); line-height: inherit; overflow: auto; border-radius: 6px; border: 1px solid var(--db--colors-gray003); margin-left: calc(var(--db---messagePadding)*-1); margin-right: calc(var(--db---messagePadding)*-1);"><pre class="PJLV PJLV-ihhUadU-css" style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; width: 393.96px; font-size: var(--db--fontSizes-1); border-radius: 6px; overflow-x: scroll; margin: 4px 0px;"><div class="db--c-hxIgPZ db--c-hxIgPZ-kInFMZ-theme-dark" style="box-sizing: inherit; display: flex; justify-content: space-between; align-items: center; padding: 4px; border-bottom: 1px solid var(--db--colors-gray004); background-color: rgb(13, 17, 23);"><button type="button" class="db--c-dsHufW" style="box-sizing: inherit; display: flex; gap: 4px; border: none; cursor: pointer; height: 18px; padding-right: 6px; background-color: transparent; color: var(--db--colors-gray001);"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 16 16" class="db--c-bHwuwj"><path stroke="currentColor" stroke-width="1.5" d="M13.016 10.331l1.382 2.57-2.482 1.535M11.084 9.814l-2.482 1.535 1.382 2.57"></path><path stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M11.5 8V6a1 1 0 00-1-1H5a1 1 0 00-1 1v5.5a1 1 0 001 1h1"></path><path stroke="currentColor" stroke-width="1.5" d="M9.5 5V3.5a1 1 0 00-1-1h-6a1 1 0 00-1 1v6a1 1 0 001 1H4"></path></svg>Copy snippet</button></div><code class="PJLV PJLV-igIoyjz-css language-text hljs language-plaintext" style="box-sizing: inherit; width: 393.96px; font-size: var(--db--fontSizes-1); border-radius: 6px; overflow-x: auto; padding: 1em; color: rgb(201, 209, 217); background: rgb(13, 17, 23); display: block;">databutton==0.38.34
# Addded during development:
requests
websocket-client
pandas</code></pre>
    </div>
    </pre>
    <p node="[object Object]" class="db--c-hfBFtD"
        style="box-sizing: inherit; margin: 0px 0px 6px; white-space: pre-wrap; word-break: break-word; color: rgb(221, 224, 199); font-family: Inter; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(25, 19, 58); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">
        <em style="box-sizing: inherit;">(Note: Ensure these packages are installed if not present by default)</em></p>
    <h3 level="3" node="[object Object]"
        class="db--c-bLFSMJ db--c-bLFSMJ-bjRkxR-weight-bold db--c-bLFSMJ-byOZOm-color-dark db--c-bLFSMJ-ifIGqR-css"
        style="box-sizing: inherit; margin-top: var(--db---headerSpacing); margin-right: 0px; margin-bottom: var(--db---headerSpacing); margin-left: 0px; font-weight: 600; font-size: var(--db---mediumFontSize); line-height: 16.1px; letter-spacing: normal; text-transform: none; font-family: Inter; text-rendering: optimizelegibility; color: rgb(221, 224, 199); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; orphans: 2; text-align: start; text-indent: 0px; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(25, 19, 58); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">
        API Endpoints</h3>
    <ul depth="0" node="[object Object]" class="db--c-iXCqBp db--c-jaoMDw"
        style="box-sizing: inherit; width: 395.24px; margin: 6px 0px; padding: 0px; list-style-type: disc; color: rgb(221, 224, 199); font-family: Inter; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(25, 19, 58); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">
        <li index="0" node="[object Object]" class="db--c-GvogP"
            style="box-sizing: inherit; margin: 0px 0px 6px 16px; padding-left: 8px;"><strong
                style="box-sizing: inherit; font-family: Inter; font-weight: 600;"><code
                    class="db--c-hMVyzS db--c-jHrvrQ"
                    style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">src/app/apis/portfolio/__init__.py</code></strong>:
            Handles CRUD operations for portfolio assets. Stores data in<span> </span><code
                class="db--c-hMVyzS db--c-jHrvrQ"
                style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">db.storage.json</code>.
            Calculates performance metrics by calling the<span> </span><code class="db--c-hMVyzS db--c-jHrvrQ"
                style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">historical_data</code><span> </span>API.
        </li>
        <li index="1" node="[object Object]" class="db--c-GvogP"
            style="box-sizing: inherit; margin: 0px 0px 6px 16px; padding-left: 8px;"><strong
                style="box-sizing: inherit; font-family: Inter; font-weight: 600;"><code
                    class="db--c-hMVyzS db--c-jHrvrQ"
                    style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">src/app/apis/historical_data/__init__.py</code></strong>:
            Provides historical price data. Includes a helper function<span> </span><code
                class="db--c-hMVyzS db--c-jHrvrQ"
                style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">get_price_at_time</code><span> </span>used
            by the portfolio API. Fetches data from Marketstack (stocks) and CoinGecko (crypto). Includes basic caching.
        </li>
        <li index="2" node="[object Object]" class="db--c-GvogP"
            style="box-sizing: inherit; margin: 0px 0px 6px 16px; padding-left: 8px;"><strong
                style="box-sizing: inherit; font-family: Inter; font-weight: 600;"><code
                    class="db--c-hMVyzS db--c-jHrvrQ"
                    style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">src/app/apis/ws_stocks/__init__.py</code></strong>:
            Establishes a WebSocket connection to Polygon.io, subscribes to specified stock tickers, and broadcasts
            price updates to connected frontend clients via<span> </span><code class="db--c-hMVyzS db--c-jHrvrQ"
                style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">/ws/stocks</code>.
            Runs in a separate thread.</li>
        <li index="3" node="[object Object]" class="db--c-GvogP"
            style="box-sizing: inherit; margin: 0px 0px 6px 16px; padding-left: 8px;"><strong
                style="box-sizing: inherit; font-family: Inter; font-weight: 600;"><code
                    class="db--c-hMVyzS db--c-jHrvrQ"
                    style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">src/app/apis/ws_crypto/__init__.py</code></strong>:
            Establishes a WebSocket connection to Coinbase Advanced Trade WebSocket API, subscribes to specified crypto
            pairs, and broadcasts price updates to connected frontend clients via<span> </span><code
                class="db--c-hMVyzS db--c-jHrvrQ"
                style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">/ws/crypto</code>.
            Runs in a separate thread.</li>
    </ul>
    <h3 level="3" node="[object Object]"
        class="db--c-bLFSMJ db--c-bLFSMJ-bjRkxR-weight-bold db--c-bLFSMJ-byOZOm-color-dark db--c-bLFSMJ-ifIGqR-css"
        style="box-sizing: inherit; margin-top: var(--db---headerSpacing); margin-right: 0px; margin-bottom: var(--db---headerSpacing); margin-left: 0px; font-weight: 600; font-size: var(--db---mediumFontSize); line-height: 16.1px; letter-spacing: normal; text-transform: none; font-family: Inter; text-rendering: optimizelegibility; color: rgb(221, 224, 199); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; orphans: 2; text-align: start; text-indent: 0px; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(25, 19, 58); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">
        Backend Code</h3>
    <p node="[object Object]" class="db--c-hfBFtD"
        style="box-sizing: inherit; margin: 0px 0px 6px; white-space: pre-wrap; word-break: break-word; color: rgb(221, 224, 199); font-family: Inter; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(25, 19, 58); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">
        <strong style="box-sizing: inherit; font-family: Inter; font-weight: 600;"><code
                class="db--c-hMVyzS db--c-jHrvrQ"
                style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">src/app/apis/portfolio/__init__.py</code></strong>
    </p>
    <pre
        style="box-sizing: inherit; margin: 4px 0px; color: rgb(221, 224, 199); font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(25, 19, 58); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;"><div class="db--c-dhzjXW db--c-dhzjXW-kqFZpo-direction-vertical db--c-dhzjXW-igvqKzt-css" style="box-sizing: inherit; display: flex; flex-flow: column; position: relative; color: var(--db--colors-gray001); line-height: inherit; overflow: auto; border-radius: 6px; border: 1px solid var(--db--colors-gray003); margin-left: calc(var(--db---messagePadding)*-1); margin-right: calc(var(--db---messagePadding)*-1);"><pre class="PJLV PJLV-ihhUadU-css" style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; width: 393.96px; font-size: var(--db--fontSizes-1); border-radius: 6px; overflow-x: scroll; margin: 4px 0px;"><div class="db--c-hxIgPZ db--c-hxIgPZ-kInFMZ-theme-dark" style="box-sizing: inherit; display: flex; justify-content: space-between; align-items: center; padding: 4px; border-bottom: 1px solid var(--db--colors-gray004); background-color: rgb(13, 17, 23);"><button type="button" class="db--c-dsHufW" style="box-sizing: inherit; display: flex; gap: 4px; border: none; cursor: pointer; height: 18px; padding-right: 6px; background-color: transparent; color: var(--db--colors-gray001);"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 16 16" class="db--c-bHwuwj"><path stroke="currentColor" stroke-width="1.5" d="M13.016 10.331l1.382 2.57-2.482 1.535M11.084 9.814l-2.482 1.535 1.382 2.57"></path><path stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M11.5 8V6a1 1 0 00-1-1H5a1 1 0 00-1 1v5.5a1 1 0 001 1h1"></path><path stroke="currentColor" stroke-width="1.5" d="M9.5 5V3.5a1 1 0 00-1-1h-6a1 1 0 00-1 1v6a1 1 0 001 1H4"></path></svg>Copy snippet</button></div><code class="PJLV PJLV-igIoyjz-css language-python hljs" style="box-sizing: inherit; width: 393.96px; font-size: var(--db--fontSizes-1); border-radius: 6px; overflow-x: auto; padding: 1em; color: rgb(201, 209, 217); background: rgb(13, 17, 23); display: block;"><span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> databutton <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> db
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> pandas <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> pd
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">from</span> fastapi <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> APIRouter, HTTPException
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">from</span> pydantic <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> BaseModel, Field
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">from</span> typing <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">List</span>, <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Optional</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">from</span> datetime <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> datetime, timedelta, timezone
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> logging

<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Import the helper function from historical_data API</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">try</span>:
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Ensure the import path matches the actual structure if historical_data is nested</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">from</span> app.apis.historical_data <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> get_price_at_time
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> ImportError <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> import_err:
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Provide a dummy function if import fails (e.g., during initial setup or test)</span>
    logging.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Could not import get_price_at_time from historical_data API: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{import_err}</span>. Performance calculations will fail."</span>)
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">get_price_at_time</span>(<span class="hljs-params" style="box-sizing: inherit;">symbol: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span>, target_dt: datetime, asset_type: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span></span>) -&gt; <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span> | <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>:
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>

<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Add logger instance</span>
logger = logging.getLogger(__name__)
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> logger.hasHandlers():
    logging.basicConfig(level=logging.INFO, <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">format</span>=<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>)

PORTFOLIO_KEY = <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"portfolio_assets_v2"</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Using v2 key to avoid conflicts with old structure if any</span>

<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- Models ---</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">class</span> <span class="hljs-title class_" style="box-sizing: inherit; color: rgb(210, 168, 255);">AssetInput</span>(<span class="hljs-title class_ inherited__" style="box-sizing: inherit; color: rgb(210, 168, 255);">BaseModel</span>):
    symbol: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span>
    asset_type: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span> = Field(..., pattern=<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"^(stock|crypto)$"</span>) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Enforce stock or crypto</span>
    quantity: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>
    purchase_price: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>
    purchase_date: <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Optional</span>[<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span>] = <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Optional purchase date string (ISO format preferred, e.g., YYYY-MM-DD or YYYY-MM-DDTHH:MM:SSZ)</span>

<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">class</span> <span class="hljs-title class_" style="box-sizing: inherit; color: rgb(210, 168, 255);">PortfolioAsset</span>(<span class="hljs-title class_ inherited__" style="box-sizing: inherit; color: rgb(210, 168, 255);">BaseModel</span>):
    <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">id</span>: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Unique ID for the asset holding (e.g., symbol + purchase timestamp)</span>
    symbol: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span>
    asset_type: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span>
    quantity: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>
    purchase_price: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>
    purchase_date: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Store as ISO string (UTC)</span>
    current_value: <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Optional</span>[<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>] = <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Calculated field (using placeholder price for now)</span>
    profit_loss: <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Optional</span>[<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>] = <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Calculated field (using placeholder price for now)</span>
    profit_loss_pct: <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Optional</span>[<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>] = <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Calculated field (using placeholder price for now)</span>
    change_1h: <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Optional</span>[<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>] = <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Performance % change vs 1h ago</span>
    change_1w: <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Optional</span>[<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>] = <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Performance % change vs 1w ago</span>
    change_1m: <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Optional</span>[<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>] = <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Performance % change vs 1m ago</span>

<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">class</span> <span class="hljs-title class_" style="box-sizing: inherit; color: rgb(210, 168, 255);">PortfolioResponse</span>(<span class="hljs-title class_ inherited__" style="box-sizing: inherit; color: rgb(210, 168, 255);">BaseModel</span>):
    assets: <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">List</span>[PortfolioAsset]
    total_value: <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Optional</span>[<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>] = <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Calculated total (using placeholder price)</span>
    total_profit_loss: <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Optional</span>[<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>] = <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Calculated total (using placeholder price)</span>
    total_profit_loss_pct: <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Optional</span>[<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>] = <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Calculated total (using placeholder price)</span>

router = APIRouter() <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Mount at /portfolio by main app or explicit prefix</span>

<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- Helper Functions ---</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">calculate_performance</span>(<span class="hljs-params" style="box-sizing: inherit;">current_price: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span> | <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>, historical_price: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span> | <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span></span>) -&gt; <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span> | <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>:
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"""Calculates percentage change, handling None values."""</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> current_price <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">is</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">or</span> historical_price <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">is</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>:
        <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># logger.debug(f"Cannot calculate performance: current={current_price}, historical={historical_price}")</span>
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> historical_price == <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">0</span>:
         <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Handle case where historical price was 0 (or very close)</span>
         <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> current_price &gt; <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">0</span>:
              <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span> <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'inf'</span>) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Or a large number to indicate significant growth</span>
         <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">elif</span> current_price &lt; <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">0</span>:
              <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span> <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'-inf'</span>)
         <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span>:
              <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span> <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">0.0</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># No change from zero</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">try</span>:
         change = ((current_price - historical_price) / historical_price) * <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">100</span>
         <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># logger.debug(f"Calculated performance: current={current_price}, historical={historical_price}, change={change:.2f}%")</span>
         <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span> change
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> Exception <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> e:
         <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Catch potential division issues if not covered above, though unlikely with float</span>
         logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Exception calculating performance: current=<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{current_price}</span>, historical=<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{historical_price}</span>, Error: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{e}</span>"</span>)
         <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>

<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- API Endpoints ---</span>

<span class="hljs-meta" style="box-sizing: inherit; color: rgb(121, 192, 255);">@router.post(<span class="hljs-params" style="box-sizing: inherit;"><span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"/portfolio"</span>, response_model=PortfolioAsset, status_code=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">201</span></span>)</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">add_asset_to_portfolio</span>(<span class="hljs-params" style="box-sizing: inherit;">asset: AssetInput</span>):
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"""Adds a new asset holding to the portfolio."""</span>
    portfolio_data = db.storage.json.get(PORTFOLIO_KEY, default=[])
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">isinstance</span>(portfolio_data, <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">list</span>):
        logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Portfolio data at <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{PORTFOLIO_KEY}</span> was not a list (<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">type</span>(portfolio_data)}</span>), resetting."</span>)
        portfolio_data = []

    purchase_dt = datetime.now(timezone.utc) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Default to now UTC</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> asset.purchase_date:
         <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">try</span>:
              <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Attempt to parse various common date/datetime formats using pandas</span>
              pd_ts = pd.Timestamp(asset.purchase_date)
              <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> pd_ts.tzinfo <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">is</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>:
                   <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># If no timezone in string, assume UTC as per typical ISO interpretation</span>
                   purchase_dt = pd_ts.tz_localize(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'UTC'</span>).to_pydatetime()
              <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span>:
                   <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Convert to UTC if timezone was present</span>
                   purchase_dt = pd_ts.tz_convert(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'UTC'</span>).to_pydatetime()
              logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Parsed purchase date '<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{asset.purchase_date}</span>' to UTC: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{purchase_dt.isoformat()}</span>"</span>)
         <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> (ValueError, TypeError) <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> e:
              logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Invalid purchase_date format '<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{asset.purchase_date}</span>': <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{e}</span>"</span>)
              <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">raise</span> HTTPException(status_code=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">400</span>, detail=<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Invalid purchase_date format: '<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{asset.purchase_date}</span>'. Use YYYY-MM-DD or ISO 8601 format."</span>) <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">from</span> e

    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Ensure quantity and price are valid</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> asset.quantity &lt;= <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">0</span>:
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">raise</span> HTTPException(status_code=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">400</span>, detail=<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Quantity must be positive."</span>)
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> asset.purchase_price &lt;= <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">0</span>:
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">raise</span> HTTPException(status_code=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">400</span>, detail=<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Purchase price must be positive."</span>)

    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Create a unique ID, e.g., symbol-timestamp</span>
    asset_id = <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{asset.symbol.upper()}</span>-<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">int</span>(purchase_dt.timestamp())}</span>"</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Use uppercase symbol</span>

    new_asset = PortfolioAsset(
        <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">id</span>=asset_id,
        symbol=asset.symbol.upper(), <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Store symbol uppercase</span>
        asset_type=asset.asset_type.lower(), <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Store type lowercase</span>
        quantity=asset.quantity,
        purchase_price=asset.purchase_price,
        purchase_date=purchase_dt.isoformat().replace(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'+00:00'</span>, <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'Z'</span>), <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Store as ISO string UTC (Z format)</span>
        <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Current value and P/L will be calculated in GET</span>
    )

    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Check for duplicates (optional, based on desired logic - e.g., same symbol added on same second?)</span>
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># For simplicity, we allow multiple entries for the same symbol if purchase times differ.</span>

    portfolio_data.append(new_asset.model_dump()) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Store as dict</span>
    db.storage.json.put(PORTFOLIO_KEY, portfolio_data)
    logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Added asset <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{asset_id}</span> to portfolio."</span>)

    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span> new_asset <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Return the created asset model</span>


<span class="hljs-meta" style="box-sizing: inherit; color: rgb(121, 192, 255);">@router.get(<span class="hljs-params" style="box-sizing: inherit;"><span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"/portfolio"</span>, response_model=PortfolioResponse</span>)</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">get_portfolio</span>():
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"""Retrieves the portfolio, calculates current values, P/L, and performance."""</span>
    portfolio_assets_stored = db.storage.json.get(PORTFOLIO_KEY, default=[])
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">isinstance</span>(portfolio_assets_stored, <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">list</span>):
        logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Portfolio data at <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{PORTFOLIO_KEY}</span> is not a list (<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">type</span>(portfolio_assets_stored)}</span>). Returning empty."</span>)
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span> PortfolioResponse(assets=[], total_value=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">0</span>, total_profit_loss=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">0</span>, total_profit_loss_pct=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">0</span>)

    calculated_assets: <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">List</span>[PortfolioAsset] = []
    total_portfolio_value = <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">0.0</span>
    total_purchase_value = <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">0.0</span>
    now_utc = datetime.now(timezone.utc)

    logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Calculating portfolio state for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">len</span>(portfolio_assets_stored)}</span> stored assets."</span>)

    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">for</span> asset_data <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">in</span> portfolio_assets_stored:
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">try</span>:
             <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Re-create the Pydantic model instance for validation and structure</span>
             asset = PortfolioAsset(**asset_data)

             <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Get current price (using the imported historical function as a proxy for 'current')</span>
             <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># In a real-time system, you might fetch this from a live feed or recent cache.</span>
             <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># For consistency here, we use get_price_at_time with 'now_utc'.</span>
             current_price = get_price_at_time(asset.symbol, now_utc, asset.asset_type)

             <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Calculate times for performance checks</span>
             time_1h_ago = now_utc - timedelta(hours=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">1</span>)
             time_1w_ago = now_utc - timedelta(weeks=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">1</span>)
             time_1m_ago = now_utc - timedelta(days=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">30</span>) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Approx 1 month</span>

             <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Fetch historical prices</span>
             price_1h_ago = get_price_at_time(asset.symbol, time_1h_ago, asset.asset_type)
             price_1w_ago = get_price_at_time(asset.symbol, time_1w_ago, asset.asset_type)
             price_1m_ago = get_price_at_time(asset.symbol, time_1m_ago, asset.asset_type)

             <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Calculate metrics</span>
             asset.current_value = (current_price * asset.quantity) <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> current_price <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">is</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>
             purchase_value = asset.purchase_price * asset.quantity
             asset.profit_loss = (asset.current_value - purchase_value) <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> asset.current_value <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">is</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>
             asset.profit_loss_pct = calculate_performance(asset.current_value, purchase_value) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># P/L % uses purchase value as base</span>

             <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Calculate performance changes (vs historical prices)</span>
             asset.change_1h = calculate_performance(current_price, price_1h_ago)
             asset.change_1w = calculate_performance(current_price, price_1w_ago)
             asset.change_1m = calculate_performance(current_price, price_1m_ago)

             calculated_assets.append(asset)

             <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Add to totals if value is calculable</span>
             <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> asset.current_value <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">is</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>:
                 total_portfolio_value += asset.current_value
                 total_purchase_value += purchase_value <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Sum purchase value only for assets with current value</span>

        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> Exception <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> e:
             logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Error processing asset data: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{asset_data}</span>. Error: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{e}</span>"</span>, exc_info=<span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">True</span>)
             <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Optionally skip this asset or handle error differently</span>
             <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">continue</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Skip this asset if processing failed</span>

    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Calculate overall portfolio P/L</span>
    total_profit_loss = total_portfolio_value - total_purchase_value <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> total_purchase_value <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">is</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>
    total_profit_loss_pct = calculate_performance(total_portfolio_value, total_purchase_value) <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> total_purchase_value <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">is</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>

    logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Portfolio calculation complete. Total Value: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{total_portfolio_value:<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">.2</span>f}</span>, Total P/L: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{total_profit_loss <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> total_profit_loss <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">is</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span> <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'N/A'</span>}</span>"</span>)

    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span> PortfolioResponse(
        assets=calculated_assets,
        total_value=total_portfolio_value,
        total_profit_loss=total_profit_loss,
        total_profit_loss_pct=total_profit_loss_pct
    )

<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Add DELETE endpoint if needed (e.g., /portfolio/{asset_id})</span>
<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Remember to handle removal from the list stored in db.storage.json</span></code></pre>
    </div>
    </pre>
    <p node="[object Object]" class="db--c-hfBFtD"
        style="box-sizing: inherit; margin: 0px 0px 6px; white-space: pre-wrap; word-break: break-word; color: rgb(221, 224, 199); font-family: Inter; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(25, 19, 58); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">
        <strong style="box-sizing: inherit; font-family: Inter; font-weight: 600;"><code
                class="db--c-hMVyzS db--c-jHrvrQ"
                style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">src/app/apis/historical_data/__init__.py</code></strong>
    </p>
    <pre
        style="box-sizing: inherit; margin: 4px 0px; color: rgb(221, 224, 199); font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(25, 19, 58); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;"><div class="db--c-dhzjXW db--c-dhzjXW-kqFZpo-direction-vertical db--c-dhzjXW-igvqKzt-css" style="box-sizing: inherit; display: flex; flex-flow: column; position: relative; color: var(--db--colors-gray001); line-height: inherit; overflow: auto; border-radius: 6px; border: 1px solid var(--db--colors-gray003); margin-left: calc(var(--db---messagePadding)*-1); margin-right: calc(var(--db---messagePadding)*-1);"><pre class="PJLV PJLV-ihhUadU-css" style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; width: 393.96px; font-size: var(--db--fontSizes-1); border-radius: 6px; overflow-x: scroll; margin: 4px 0px;"><div class="db--c-hxIgPZ db--c-hxIgPZ-kInFMZ-theme-dark" style="box-sizing: inherit; display: flex; justify-content: space-between; align-items: center; padding: 4px; border-bottom: 1px solid var(--db--colors-gray004); background-color: rgb(13, 17, 23);"><button type="button" class="db--c-dsHufW" style="box-sizing: inherit; display: flex; gap: 4px; border: none; cursor: pointer; height: 18px; padding-right: 6px; background-color: transparent; color: var(--db--colors-gray001);"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 16 16" class="db--c-bHwuwj"><path stroke="currentColor" stroke-width="1.5" d="M13.016 10.331l1.382 2.57-2.482 1.535M11.084 9.814l-2.482 1.535 1.382 2.57"></path><path stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M11.5 8V6a1 1 0 00-1-1H5a1 1 0 00-1 1v5.5a1 1 0 001 1h1"></path><path stroke="currentColor" stroke-width="1.5" d="M9.5 5V3.5a1 1 0 00-1-1h-6a1 1 0 00-1 1v6a1 1 0 001 1H4"></path></svg>Copy snippet</button></div><code class="PJLV PJLV-igIoyjz-css language-python hljs" style="box-sizing: inherit; width: 393.96px; font-size: var(--db--fontSizes-1); border-radius: 6px; overflow-x: auto; padding: 1em; color: rgb(201, 209, 217); background: rgb(13, 17, 23); display: block;"><span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># src/app/apis/historical_data/__init__.py</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> requests
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">from</span> fastapi <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> APIRouter, HTTPException, Query
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">from</span> pydantic <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> BaseModel, Field
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> databutton <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> db
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">from</span> datetime <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> datetime, timedelta, date, timezone <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Added timezone</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> time
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> logging
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> pandas <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> pd <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Added pandas</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">from</span> typing <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Dict</span>, <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Any</span>, <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">List</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Added for caching type hint &amp; List for return type</span>

<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Setup basic logging</span>
logger = logging.getLogger(__name__)
<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Ensure handlers are not added multiple times in dev environments</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> logger.hasHandlers():
    logging.basicConfig(level=logging.INFO, <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">format</span>=<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>)



router = APIRouter(prefix=<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"/history"</span>, tags=[<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"HistoricalData"</span>])

<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- Configuration ---</span>
MARKETSTACK_API_KEY = db.secrets.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"MARKETSTACK_API_KEY"</span>)
MARKETSTACK_BASE_URL = <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"http://api.marketstack.com/v1"</span>
COINGECKO_API_URL = <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"https://api.coingecko.com/api/v3"</span>
COINGECKO_LIST_CACHE_KEY = <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"coingecko_coin_list"</span>
COINGECKO_LIST_CACHE_DURATION = <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">60</span> * <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">60</span> * <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">24</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Cache CoinGecko list for 24 hours</span>

<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- Simple In-Memory Cache (replace with Redis/Memcached for production) ---</span>
<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Cache structure: {'symbol_assetType': {'timestamp': time.time(), 'data': price_data}}</span>
price_cache: <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Dict</span>[<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span>, <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Dict</span>[<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span>, <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Any</span>]] = {}
CACHE_DURATION_SECONDS = <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">60</span> * <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">5</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Cache prices for 5 minutes</span>


<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- Helper Function to get CoinGecko ID from Symbol ---</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">get_coingecko_id</span>(<span class="hljs-params" style="box-sizing: inherit;">symbol: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span></span>) -&gt; <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span> | <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>:
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"""Maps a symbol (like BTC, ETH) to its CoinGecko ID (like bitcoin, ethereum)."""</span>
    symbol_lower = symbol.lower()
    cached_list_data = db.storage.json.get(COINGECKO_LIST_CACHE_KEY, default=<span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>)
    now = time.time()

    coin_list = <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> cached_list_data <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">and</span> (now - cached_list_data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'timestamp'</span>, <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">0</span>)) &lt; COINGECKO_LIST_CACHE_DURATION:
        coin_list = cached_list_data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'data'</span>)
        logger.debug(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Using cached CoinGecko coin list."</span>)
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span>:
        logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Fetching fresh CoinGecko coin list."</span>)
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">try</span>:
            response = requests.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{COINGECKO_API_URL}</span>/coins/list"</span>)
            response.raise_for_status()
            coin_list = response.json()
            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Cache the list with timestamp</span>
            db.storage.json.put(COINGECKO_LIST_CACHE_KEY, {<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'timestamp'</span>: now, <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'data'</span>: coin_list})
            logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Fetched and cached <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">len</span>(coin_list)}</span> coins from CoinGecko."</span>)
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> requests.exceptions.RequestException <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> e:
            logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Failed to fetch CoinGecko coin list: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{e}</span>"</span>)
            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Attempt to use potentially stale cache if fetch fails</span>
            coin_list = cached_list_data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'data'</span>) <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> cached_list_data <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> coin_list:
                <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># No list available</span>

    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> coin_list:
        logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"CoinGecko coin list is unavailable."</span>)
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>

    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Find the coin by symbol</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">for</span> coin <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">in</span> coin_list:
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> coin.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'symbol'</span>) == symbol_lower:
            logger.debug(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Mapped crypto symbol '<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span>' to CoinGecko ID '<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{coin.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'id'</span>)}</span>'"</span>)
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span> coin.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'id'</span>)

    logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Could not find CoinGecko ID for symbol: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span>"</span>)
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>


<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- Helper Function to get price near a specific time (REVISED) ---</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">get_price_at_time</span>(<span class="hljs-params" style="box-sizing: inherit;">symbol: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span>, target_dt: datetime, asset_type: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span></span>) -&gt; <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span> | <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>:
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"""
    Fetches the closing price for a symbol as close as possible to the target datetime.
    Checks data up to 3 days before the target_dt to handle weekends/holidays/API gaps.
    Uses Marketstack for stocks and CoinGecko for crypto. Caches results.
    """</span>
    cache_key = <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol.upper()}</span>_<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{asset_type}</span>_<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{target_dt.strftime(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'%Y-%m-%d_%H%M'</span>)}</span>"</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Cache key includes time roughly</span>
    now = time.time()

    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Check cache first</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> cache_key <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">in</span> price_cache <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">and</span> (now - price_cache[cache_key][<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'timestamp'</span>]) &lt; CACHE_DURATION_SECONDS:
        logger.debug(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"[get_price_at_time - Cache] HIT for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{cache_key}</span>"</span>)
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span> price_cache[cache_key][<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'data'</span>]

    logger.debug(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"[get_price_at_time - Fetch] No valid cache for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{cache_key}</span>"</span>)

    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Ensure target_dt is timezone-aware (UTC)</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> target_dt.tzinfo <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">is</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">or</span> target_dt.tzinfo.utcoffset(target_dt) <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">is</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>:
        target_dt = target_dt.replace(tzinfo=timezone.utc)
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span>:
        target_dt = target_dt.astimezone(timezone.utc)

    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Check a range ending on the target date to find the closest available data point</span>
    date_to = target_dt.strftime(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'%Y-%m-%d'</span>)
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Look back more days to increase chance of finding data</span>
    date_from = (target_dt - timedelta(days=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">4</span>)).strftime(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'%Y-%m-%d'</span>) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Increased lookback</span>

    logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"[get_price_at_time] Fetching price for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span> (<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{asset_type}</span>) near <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{target_dt.isoformat()}</span> (checking <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{date_from}</span> to <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{date_to}</span>)"</span>)

    price = <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>

    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">try</span>:
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> asset_type == <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"stock"</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">and</span> MARKETSTACK_API_KEY:
            api_url = <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{MARKETSTACK_BASE_URL}</span>/eod"</span>
            params = {
                <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"access_key"</span>: MARKETSTACK_API_KEY,
                <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"symbols"</span>: symbol.upper(),
                <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"date_from"</span>: date_from,
                <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"date_to"</span>: date_to,
                <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"limit"</span>: <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">5</span>, <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Get a few recent data points</span>
                <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"sort"</span>: <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"DESC"</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Get latest first within the range</span>
            }
            response = requests.get(api_url, params=params)
            response.raise_for_status()
            data = response.json()
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"data"</span>) <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">and</span> <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">len</span>(data[<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"data"</span>]) &gt; <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">0</span>:
                <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Find the first entry strictly ON or BEFORE the target datetime</span>
                <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">for</span> entry <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">in</span> data[<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"data"</span>]:
                     <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">try</span>:
                          entry_date_str = entry[<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"date"</span>]
                          <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Parse defensively, convert to UTC</span>
                          entry_dt = pd.Timestamp(entry_date_str).tz_convert(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'UTC'</span>)

                          <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># We want the closing price ON or BEFORE the target datetime</span>
                          <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> entry_dt &lt;= target_dt <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">and</span> entry.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"close"</span>) <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">is</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>:
                               price = <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>(entry[<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"close"</span>])
                               logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"[get_price_at_time] Found Marketstack price for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span> on <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{entry_dt.isoformat()}</span>: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{price}</span>"</span>)
                               <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">break</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Found the closest valid price</span>
                     <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> (ValueError, TypeError, KeyError) <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> parse_err:
                          logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"[get_price_at_time] Error parsing Marketstack entry date/price for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span>: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{parse_err}</span> - Entry: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{entry}</span>"</span>)
                          <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">continue</span>

                <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> price <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">is</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>:
                     logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"[get_price_at_time] No Marketstack EOD data found for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span> on or before <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{date_to}</span> in response: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'data'</span>)}</span>"</span>)
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span>:
                logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"[get_price_at_time] No Marketstack data array returned for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span> in range <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{date_from}</span> to <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{date_to}</span>. Response: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{data}</span>"</span>)

        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">elif</span> asset_type == <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"crypto"</span>:
            cg_id = get_coingecko_id(symbol)
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> cg_id:
                 logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"[get_price_at_time] Cannot map crypto symbol '<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span>' to CoinGecko ID. Skipping historical price."</span>)
                 <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Cannot proceed without ID</span>

            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># CoinGecko's free tier history is often daily granularity via /market_chart/range</span>
            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Convert target_dt and date_from to Unix timestamps (seconds)</span>
            to_ts = <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">int</span>(target_dt.timestamp())
            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Ensure 'from_ts' is sufficiently before 'to_ts' (at least 1 day + buffer)</span>
            from_ts = <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">int</span>((target_dt - timedelta(days=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">5</span>)).timestamp()) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Increased lookback for range</span>
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> from_ts &gt;= to_ts:
                 from_ts = to_ts - (<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">86400</span> * <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">2</span>) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Ensure at least ~2 days gap if target is very recent</span>

            cg_url = <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{COINGECKO_API_URL}</span>/coins/<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{cg_id}</span>/market_chart/range"</span>
            params = {
                <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"vs_currency"</span>: <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"usd"</span>,
                <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"from"</span>: from_ts,
                <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"to"</span>: to_ts
            }
            logger.debug(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"[get_price_at_time] Calling CoinGecko market_chart/range: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{cg_url}</span> with params: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{params}</span>"</span>)
            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Add delay to respect CoinGecko rate limits (adjust as needed)</span>
            time.sleep(<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">1.5</span>) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Sleep 1.5 seconds before CoinGecko call</span>
            response = requests.get(cg_url, params=params)
            response.raise_for_status()
            data = response.json()

            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"prices"</span>) <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">and</span> <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">len</span>(data[<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"prices"</span>]) &gt; <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">0</span>:
                 <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Prices list is [[timestamp_ms, price], ...], sorted ascending.</span>
                 <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Find the latest price whose timestamp is &lt;= target_dt (converted to ms)</span>
                 target_ts_ms = <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">int</span>(target_dt.timestamp() * <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">1000</span>)
                 closest_price_entry = <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>
                 <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">for</span> ts_ms, p <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">in</span> <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">reversed</span>(data[<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"prices"</span>]): <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Check from latest backwards</span>
                     <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> ts_ms &lt;= target_ts_ms:
                         closest_price_entry = [ts_ms, p]
                         <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">break</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Found the latest entry on or before the target time</span>

                 <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> closest_price_entry:
                     price = <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>(closest_price_entry[<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">1</span>])
                     price_dt = datetime.fromtimestamp(closest_price_entry[<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">0</span>] / <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">1000</span>, tz=timezone.utc)
                     logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"[get_price_at_time] Found CoinGecko price for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span> at <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{price_dt.isoformat()}</span>: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{price}</span>"</span>)
                 <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span>:
                     <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># If no price found before or at target, maybe use the earliest price if range started after target? Unlikely with buffer.</span>
                     logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"[get_price_at_time] No CoinGecko price found on or before <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{target_dt.isoformat()}</span> for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span>. Prices received: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">len</span>(data[<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'prices'</span>])}</span>"</span>)
                     <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Optionally: could use the *first* price if the date range was fully *after* the target (edge case)</span>
                     <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># price = float(data["prices"][0][1]) # Use earliest price in range as fallback? Risky.</span>

            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span>:
                logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"[get_price_at_time] No prices array in CoinGecko response for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span> in range <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{from_ts}</span> to <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{to_ts}</span>. Response: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{data}</span>"</span>)

    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> requests.exceptions.RequestException <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> e:
        logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"[get_price_at_time] API Request failed for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span> (<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{asset_type}</span>): <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{e}</span>"</span>)
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> Exception <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> e:
        logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"[get_price_at_time] Unexpected error fetching price for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span> (<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{asset_type}</span>): <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{e}</span>"</span>, exc_info=<span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">True</span>)

    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Update cache if price was found</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> price <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">is</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>:
        price_cache[cache_key] = {<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'timestamp'</span>: now, <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'data'</span>: price}
        logger.debug(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"[get_price_at_time - Cache] SET for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{cache_key}</span>"</span>)

    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span> price


<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- Models for Chart Endpoint ---</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">class</span> <span class="hljs-title class_" style="box-sizing: inherit; color: rgb(210, 168, 255);">PricePoint</span>(<span class="hljs-title class_ inherited__" style="box-sizing: inherit; color: rgb(210, 168, 255);">BaseModel</span>):
    time: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Keep as string (e.g., 'YYYY-MM-DD' or ISO for more granular)</span>
    value: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>

<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">class</span> <span class="hljs-title class_" style="box-sizing: inherit; color: rgb(210, 168, 255);">HistoricalDataResponse</span>(<span class="hljs-title class_ inherited__" style="box-sizing: inherit; color: rgb(210, 168, 255);">BaseModel</span>):
    symbol: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span>
    asset_type: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span>
    data: <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">List</span>[PricePoint]


<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- API Endpoint for Charts ---</span>
<span class="hljs-meta" style="box-sizing: inherit; color: rgb(121, 192, 255);">@router.get(<span class="hljs-params" style="box-sizing: inherit;"><span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"/{symbol}"</span>, response_model=HistoricalDataResponse</span>)</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">get_historical_data_chart</span>(<span class="hljs-params" style="box-sizing: inherit;">
    symbol: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span>,
    asset_type: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span> = Query(<span class="hljs-params" style="box-sizing: inherit;">..., pattern=<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"^(stock|crypto)$"</span></span>),
    interval: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span> = Query(<span class="hljs-params" style="box-sizing: inherit;"><span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"1d"</span>, pattern=<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"^(1h|1d|1w|1m)$"</span></span>), <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Example intervals</span>
    days: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">int</span> = Query(<span class="hljs-params" style="box-sizing: inherit;"><span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">30</span>, ge=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">1</span>, le=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">365</span></span>) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Look back period</span>
</span>):
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"""
    Fetches historical price data for a given symbol suitable for charting.
    NOTE: This is a basic implementation. Granularity (interval) support depends heavily on the API.
          Marketstack free tier often only provides EOD. CoinGecko free tier varies.
    """</span>
    logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Request for historical chart data: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span> (<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{asset_type}</span>), interval=<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{interval}</span>, days=<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{days}</span>"</span>)

    end_date = datetime.now(timezone.utc)
    start_date = end_date - timedelta(days=days)

    historical_prices: <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">List</span>[PricePoint] = []

    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">try</span>:
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> asset_type == <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"stock"</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">and</span> MARKETSTACK_API_KEY:
            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Marketstack EOD is daily. Interval parameter might be ignored by free tier.</span>
            api_url = <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{MARKETSTACK_BASE_URL}</span>/eod"</span>
            params = {
                <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"access_key"</span>: MARKETSTACK_API_KEY,
                <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"symbols"</span>: symbol.upper(),
                <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"date_from"</span>: start_date.strftime(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'%Y-%m-%d'</span>),
                <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"date_to"</span>: end_date.strftime(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'%Y-%m-%d'</span>),
                <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"limit"</span>: days + <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">5</span>, <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Fetch slightly more to be safe</span>
                <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"sort"</span>: <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"ASC"</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Get oldest first for charting</span>
            }
            response = requests.get(api_url, params=params)
            response.raise_for_status()
            data = response.json()
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"data"</span>):
                <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">for</span> entry <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">in</span> data[<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"data"</span>]:
                    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> entry.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"close"</span>) <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">is</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">and</span> entry.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"date"</span>) <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">is</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>:
                        <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Use date string directly from API for daily data</span>
                        historical_prices.append(PricePoint(time=entry[<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"date"</span>].split(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"T"</span>)[<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">0</span>], value=<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>(entry[<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"close"</span>])))
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span>:
                logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"No Marketstack data found for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span> chart."</span>)

        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">elif</span> asset_type == <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"crypto"</span>:
            cg_id = get_coingecko_id(symbol)
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> cg_id:
                <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">raise</span> HTTPException(status_code=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">404</span>, detail=<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"CoinGecko ID not found for symbol: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span>"</span>)

            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># CoinGecko API for historical chart data (daily granularity is reliable on free tier)</span>
            cg_url = <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{COINGECKO_API_URL}</span>/coins/<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{cg_id}</span>/market_chart"</span>
            params = {
                <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"vs_currency"</span>: <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"usd"</span>,
                <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"days"</span>: <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span>(days), <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Request data for the specified number of days</span>
                <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"interval"</span>: <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"daily"</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Explicitly request daily interval</span>
            }
            logger.debug(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Calling CoinGecko market_chart: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{cg_url}</span> with params: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{params}</span>"</span>)
            time.sleep(<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">1.5</span>) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Rate limit</span>
            response = requests.get(cg_url, params=params)
            response.raise_for_status()
            data = response.json()

            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"prices"</span>):
                <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">for</span> ts_ms, price_val <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">in</span> data[<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"prices"</span>]:
                    dt_obj = datetime.fromtimestamp(ts_ms / <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">1000</span>, tz=timezone.utc)
                    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Format timestamp as YYYY-MM-DD for daily charts</span>
                    historical_prices.append(PricePoint(time=dt_obj.strftime(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'%Y-%m-%d'</span>), value=<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>(price_val)))
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span>:
                logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"No CoinGecko price data found for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span> chart."</span>)

    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> requests.exceptions.RequestException <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> e:
        logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"API Request failed for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span> chart (<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{asset_type}</span>): <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{e}</span>"</span>)
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">raise</span> HTTPException(status_code=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">503</span>, detail=<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Failed to fetch data from external API: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{e}</span>"</span>)
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> Exception <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> e:
        logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Unexpected error fetching chart data for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span> (<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{asset_type}</span>): <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{e}</span>"</span>, exc_info=<span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">True</span>)
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">raise</span> HTTPException(status_code=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">500</span>, detail=<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Internal server error while fetching historical data."</span>)

    logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Returning <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">len</span>(historical_prices)}</span> data points for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span> chart."</span>)
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span> HistoricalDataResponse(symbol=symbol, asset_type=asset_type, data=historical_prices)
</code></pre>
    </div>
    </pre>
    <p node="[object Object]" class="db--c-hfBFtD"
        style="box-sizing: inherit; margin: 0px 0px 6px; white-space: pre-wrap; word-break: break-word; color: rgb(221, 224, 199); font-family: Inter; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(25, 19, 58); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">
        <strong style="box-sizing: inherit; font-family: Inter; font-weight: 600;"><code
                class="db--c-hMVyzS db--c-jHrvrQ"
                style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">src/app/apis/ws_stocks/__init__.py</code></strong>
    </p>
    <pre
        style="box-sizing: inherit; margin: 4px 0px; color: rgb(221, 224, 199); font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(25, 19, 58); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;"><div class="db--c-dhzjXW db--c-dhzjXW-kqFZpo-direction-vertical db--c-dhzjXW-igvqKzt-css" style="box-sizing: inherit; display: flex; flex-flow: column; position: relative; color: var(--db--colors-gray001); line-height: inherit; overflow: auto; border-radius: 6px; border: 1px solid var(--db--colors-gray003); margin-left: calc(var(--db---messagePadding)*-1); margin-right: calc(var(--db---messagePadding)*-1);"><pre class="PJLV PJLV-ihhUadU-css" style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; width: 393.96px; font-size: var(--db--fontSizes-1); border-radius: 6px; overflow-x: scroll; margin: 4px 0px;"><div class="db--c-hxIgPZ db--c-hxIgPZ-kInFMZ-theme-dark" style="box-sizing: inherit; display: flex; justify-content: space-between; align-items: center; padding: 4px; border-bottom: 1px solid var(--db--colors-gray004); background-color: rgb(13, 17, 23);"><button type="button" class="db--c-dsHufW" style="box-sizing: inherit; display: flex; gap: 4px; border: none; cursor: pointer; height: 18px; padding-right: 6px; background-color: transparent; color: var(--db--colors-gray001);"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 16 16" class="db--c-bHwuwj"><path stroke="currentColor" stroke-width="1.5" d="M13.016 10.331l1.382 2.57-2.482 1.535M11.084 9.814l-2.482 1.535 1.382 2.57"></path><path stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M11.5 8V6a1 1 0 00-1-1H5a1 1 0 00-1 1v5.5a1 1 0 001 1h1"></path><path stroke="currentColor" stroke-width="1.5" d="M9.5 5V3.5a1 1 0 00-1-1h-6a1 1 0 00-1 1v6a1 1 0 001 1H4"></path></svg>Copy snippet</button></div><code class="PJLV PJLV-igIoyjz-css language-python hljs" style="box-sizing: inherit; width: 393.96px; font-size: var(--db--fontSizes-1); border-radius: 6px; overflow-x: auto; padding: 1em; color: rgb(201, 209, 217); background: rgb(13, 17, 23); display: block;"><span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># src/app/apis/ws_stocks/__init__.py</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> asyncio
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> json
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> logging
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> threading
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> time
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">from</span> typing <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">List</span>, <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Dict</span>, <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Any</span>

<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> databutton <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> db
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> websocket <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># websocket-client library</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">from</span> fastapi <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> APIRouter, WebSocket, WebSocketDisconnect

logger = logging.getLogger(__name__)
<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Avoid duplicate handlers if basicConfig was called elsewhere</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> logger.hasHandlers():
    logging.basicConfig(level=logging.INFO, <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">format</span>=<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>)

router = APIRouter()

<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- Configuration ---</span>
POLYGON_API_KEY = db.secrets.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"POLYGON_API_KEY"</span>)
POLYGON_WS_URL = <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"wss://socket.polygon.io/stocks"</span>
<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Define stock tickers - consider making this configurable</span>
STOCK_TICKERS = [<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"AAPL"</span>, <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"MSFT"</span>, <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"GOOG"</span>, <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"TSLA"</span>, <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"AMZN"</span>, <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"NVDA"</span>, <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"META"</span>]
SUBSCRIPTION_PARAMS = <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">","</span>.join([<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"T.<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{ticker}</span>"</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">for</span> ticker <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">in</span> STOCK_TICKERS])

<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- Global Variable for Main Event Loop ---</span>
main_event_loop = <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>

<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- Connection Manager ---</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">class</span> <span class="hljs-title class_" style="box-sizing: inherit; color: rgb(210, 168, 255);">ConnectionManager</span>:
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">__init__</span>(<span class="hljs-params" style="box-sizing: inherit;">self</span>):
        self.active_connections: <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">List</span>[WebSocket] = []
        self.lock = asyncio.Lock() <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Use asyncio Lock for async context</span>

    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">async</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">connect</span>(<span class="hljs-params" style="box-sizing: inherit;">self, websocket: WebSocket</span>):
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">await</span> websocket.accept()
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">async</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">with</span> self.lock:
            self.active_connections.append(websocket)
        logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Stock client connected: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{websocket.client}</span>. Total: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">len</span>(self.active_connections)}</span>"</span>)

    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">async</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">disconnect</span>(<span class="hljs-params" style="box-sizing: inherit;">self, websocket: WebSocket</span>): <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Made async to use lock</span>
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">async</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">with</span> self.lock:
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">try</span>:
                self.active_connections.remove(websocket)
                logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Stock client disconnected: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{websocket.client}</span>. Total: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">len</span>(self.active_connections)}</span>"</span>)
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> ValueError:
                logger.debug(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Attempted to disconnect an already removed stock client: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{websocket.client}</span>"</span>)
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> Exception <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> e:
                logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Error during stock client disconnection <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{websocket.client}</span>: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{e}</span>"</span>)

    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">async</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">broadcast_json</span>(<span class="hljs-params" style="box-sizing: inherit;">self, data: <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Dict</span>[<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span>, <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Any</span>]</span>):
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">async</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">with</span> self.lock:
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> self.active_connections:
                <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span>

            tasks = [conn.send_json(data) <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">for</span> conn <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">in</span> self.active_connections]
            results = <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">await</span> asyncio.gather(*tasks, return_exceptions=<span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">True</span>)

            disconnected_clients = []
            active_conn_copy = self.active_connections[:] <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Iterate over a copy for safe removal</span>

            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">for</span> i, result <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">in</span> <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">enumerate</span>(results):
                <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">isinstance</span>(result, Exception):
                    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Ensure index is valid before accessing original list if needed, but safer with copy</span>
                     <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> i &lt; <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">len</span>(active_conn_copy):
                        client_to_remove = active_conn_copy[i]
                        logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Failed to send message to stock client <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{client_to_remove.client}</span>: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{result}</span>. Marking for removal."</span>)
                        <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Check if it hasn't been removed already by concurrent disconnect</span>
                        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> client_to_remove <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">in</span> self.active_connections:
                             disconnected_clients.append(client_to_remove)
                     <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span>:
                          <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># This case should ideally not happen if we iterate correctly</span>
                          logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Index out of range during stock broadcast error handling. Index: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{i}</span>, Active Connections: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">len</span>(self.active_connections)}</span>"</span>)


            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Remove disconnected clients outside the iteration using the lock</span>
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> disconnected_clients:
                <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">for</span> client <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">in</span> disconnected_clients:
                     <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Use await here as disconnect is now async</span>
                     <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">await</span> self.disconnect(client)
                logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Removed <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">len</span>(disconnected_clients)}</span> stock clients after broadcast errors."</span>)

manager = ConnectionManager()

<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- Polygon WebSocket Background Thread ---</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">polygon_websocket_client_thread</span>(<span class="hljs-params" style="box-sizing: inherit;">loop: asyncio.AbstractEventLoop</span>):
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"""Connects to Polygon, runs loop, passes main loop to callbacks."""</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">global</span> main_event_loop <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Ensure we are setting the global</span>
    main_event_loop = loop <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Store the main loop passed from FastAPI startup</span>
    logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Polygon thread started, using event loop: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{loop}</span>"</span>)

    ws_app = <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">while</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">True</span>:
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">try</span>:
            logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Connecting to Polygon WebSocket at <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{POLYGON_WS_URL}</span>..."</span>)
            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Pass the loop to the message handler via a lambda or functools.partial</span>
            on_message_with_loop = <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">lambda</span> ws, msg: on_polygon_message(ws, msg, loop)

            ws_app = websocket.WebSocketApp(POLYGON_WS_URL,
                                          on_open=on_polygon_open,
                                          on_message=on_message_with_loop,
                                          on_error=on_polygon_error,
                                          on_close=on_polygon_close)
            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># ping interval helps keep connection alive, timeout detects stale connections</span>
            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># reconnect parameter attempts reconnection automatically on certain failures (added)</span>
            ws_app.run_forever(ping_interval=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">30</span>, ping_timeout=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">10</span>, reconnect=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">5</span>) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Added reconnect=5</span>

        <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Specific exceptions first</span>
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> websocket.WebSocketTimeoutException:
             logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Polygon WebSocket timed out. Attempting reconnect via run_forever..."</span>)
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> websocket.WebSocketConnectionClosedException:
             logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Polygon WebSocket connection closed unexpectedly. Attempting reconnect via run_forever..."</span>)
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> websocket.WebSocketException <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> e:
            logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Polygon WebSocketException: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{e}</span>. Attempting reconnect via run_forever..."</span>)
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> Exception <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> e:
            logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Unexpected error in Polygon client loop: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{e}</span>. Attempting restart..."</span>, exc_info=<span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">True</span>)

        <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Explicit delay before restarting loop if run_forever exits unexpectedly</span>
        logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Polygon run_forever loop ended. Waiting 10 seconds before restarting connection attempt."</span>)
        time.sleep(<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">10</span>)
        <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># No need to explicitly close ws_app here if run_forever handles it or reconnect logic takes over</span>


<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">on_polygon_message</span>(<span class="hljs-params" style="box-sizing: inherit;">ws, message, loop: asyncio.AbstractEventLoop</span>):
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"""Callback for handling messages from Polygon."""</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">try</span>:
        data_list = json.loads(message)
        <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># logger.debug(f"Raw Polygon message: {message}") # Log raw message if needed</span>

        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">for</span> data <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">in</span> data_list:
            event_type = data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"ev"</span>)
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> event_type == <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"status"</span>:
                logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Polygon Status: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'message'</span>)}</span>"</span>)
                <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Handle auth status specifically</span>
                <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"status"</span>) == <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"auth_success"</span>:
                    logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Polygon authentication successful. Subscribing to tickers..."</span>)
                    ws.send(json.dumps({<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"action"</span>: <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"subscribe"</span>, <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"params"</span>: SUBSCRIPTION_PARAMS}))
                <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">elif</span> data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"status"</span>) == <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"success"</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">and</span> data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"message"</span>, <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">""</span>).startswith(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"subscribed to"</span>):
                     logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Successfully subscribed to Polygon tickers: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'message'</span>)}</span>"</span>)

            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">elif</span> event_type == <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"T"</span>: <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Trade event</span>
                symbol = data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"sym"</span>)
                price = data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"p"</span>)
                timestamp_ms = data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"t"</span>) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Polygon uses ms timestamp</span>

                <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> symbol <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">and</span> price <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">is</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">and</span> timestamp_ms <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">is</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>:
                    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># logger.debug(f"Stock Trade: {symbol} Price: {price} Time: {timestamp_ms}")</span>
                    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Prepare data for broadcasting to frontend clients</span>
                    broadcast_data = {
                        <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"type"</span>: <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"StockTrade"</span>, <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Custom type for frontend differentiation</span>
                        <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"sym"</span>: symbol,
                        <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"p"</span>: price,
                        <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"t"</span>: timestamp_ms <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Send original ms timestamp</span>
                    }
                    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Schedule broadcast on the main event loop</span>
                    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> loop <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">and</span> loop.is_running():
                        <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Ensure broadcast_json is awaited</span>
                        asyncio.run_coroutine_threadsafe(manager.broadcast_json(broadcast_data), loop)
                    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span>:
                        logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Main event loop not available or not running for stock broadcast."</span>)
                <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span>:
                    logger.debug(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Ignoring incomplete trade event: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{data}</span>"</span>)
            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Handle other event types if needed (e.g., 'Q' for quotes, 'A' for aggregates)</span>

    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> json.JSONDecodeError:
        logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Failed to decode JSON from Polygon: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{message}</span>"</span>)
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> Exception <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> e:
        logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Error processing Polygon message: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{e}</span>"</span>, exc_info=<span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">True</span>)

<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">on_polygon_error</span>(<span class="hljs-params" style="box-sizing: inherit;">ws, error</span>):
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"""Callback for WebSocket errors."""</span>
    logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Polygon WebSocket Error: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{error}</span>"</span>)

<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">on_polygon_close</span>(<span class="hljs-params" style="box-sizing: inherit;">ws, close_status_code, close_msg</span>):
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"""Callback when the WebSocket connection is closed."""</span>
    logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Polygon WebSocket connection closed. Code: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{close_status_code}</span>, Msg: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{close_msg}</span>"</span>)
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Reconnection logic is handled by run_forever(reconnect=...)</span>

<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">on_polygon_open</span>(<span class="hljs-params" style="box-sizing: inherit;">ws</span>):
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"""Callback when the WebSocket connection is opened."""</span>
    logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Polygon WebSocket connection opened. Authenticating..."</span>)
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Authenticate with API Key</span>
    ws.send(json.dumps({<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"action"</span>: <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"auth"</span>, <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"params"</span>: POLYGON_API_KEY}))
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Subscription happens after successful auth status message</span>


<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- FastAPI WebSocket Endpoint ---</span>
<span class="hljs-meta" style="box-sizing: inherit; color: rgb(121, 192, 255);">@router.websocket(<span class="hljs-params" style="box-sizing: inherit;"><span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"/ws/stocks"</span></span>)</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">async</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">websocket_endpoint_stocks</span>(<span class="hljs-params" style="box-sizing: inherit;">websocket: WebSocket</span>):
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"""Handles frontend client connections for stock data."""</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">await</span> manager.connect(websocket)
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">try</span>:
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">while</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">True</span>:
            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Keep connection open, listens for client messages (optional)</span>
            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># data = await websocket.receive_text()</span>
            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># logger.info(f"Received from stock client {websocket.client}: {data}")</span>
            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># If you need to handle client messages, add logic here</span>
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">await</span> asyncio.sleep(<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">60</span>) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Keep alive check or wait indefinitely</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> WebSocketDisconnect:
        logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Stock client <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{websocket.client}</span> disconnected (WebSocketDisconnect)"</span>)
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">await</span> manager.disconnect(websocket)
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> Exception <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> e:
        logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Error in stock websocket connection for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{websocket.client}</span>: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{e}</span>"</span>, exc_info=<span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">True</span>)
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">await</span> manager.disconnect(websocket) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Ensure disconnect on error</span>


<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- Startup Event to Launch Background Thread ---</span>
<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># This should be called from main.py or a central startup mechanism</span>
_stock_thread = <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>

<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">start_stock_websocket_thread</span>():
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">global</span> _stock_thread
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> POLYGON_API_KEY:
        logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"POLYGON_API_KEY secret not set. Stock WebSocket will not start."</span>)
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span>

    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> _stock_thread <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">is</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">or</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> _stock_thread.is_alive():
        loop = asyncio.get_event_loop()
        _stock_thread = threading.Thread(target=polygon_websocket_client_thread, args=(loop,), daemon=<span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">True</span>)
        _stock_thread.start()
        logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Polygon WebSocket client thread started."</span>)
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span>:
        logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Polygon WebSocket client thread already running."</span>)

<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- Optional Shutdown ---</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">stop_stock_websocket_thread</span>():
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># This is harder to implement gracefully with websocket-client's run_forever</span>
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Usually relies on daemon=True and program exit.</span>
    logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Stock WebSocket thread shutdown requested (best effort)."</span>)
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># ws_app.close() might be called from within the thread on program exit signals if possible</span>
</code></pre>
    </div>
    </pre>
    <p node="[object Object]" class="db--c-hfBFtD"
        style="box-sizing: inherit; margin: 0px 0px 6px; white-space: pre-wrap; word-break: break-word; color: rgb(221, 224, 199); font-family: Inter; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(25, 19, 58); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">
        <strong style="box-sizing: inherit; font-family: Inter; font-weight: 600;"><code
                class="db--c-hMVyzS db--c-jHrvrQ"
                style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; padding: 1px 4px; background-color: var(--db--colors-gray004); border: 1px solid var(--db--colors-gray002); border-radius: 4px;">src/app/apis/ws_crypto/__init__.py</code></strong>
    </p>
    <pre
        style="box-sizing: inherit; margin: 4px 0px; color: rgb(221, 224, 199); font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(25, 19, 58); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;"><div class="db--c-dhzjXW db--c-dhzjXW-kqFZpo-direction-vertical db--c-dhzjXW-igvqKzt-css" style="box-sizing: inherit; display: flex; flex-flow: column; position: relative; color: var(--db--colors-gray001); line-height: inherit; overflow: auto; border-radius: 6px; border: 1px solid var(--db--colors-gray003); margin-left: calc(var(--db---messagePadding)*-1); margin-right: calc(var(--db---messagePadding)*-1);"><pre class="PJLV PJLV-ihhUadU-css" style="box-sizing: inherit; font-family: SohneMono-Buch; font-weight: 400; width: 393.96px; font-size: var(--db--fontSizes-1); border-radius: 6px; overflow-x: scroll; margin: 4px 0px;"><div class="db--c-hxIgPZ db--c-hxIgPZ-kInFMZ-theme-dark" style="box-sizing: inherit; display: flex; justify-content: space-between; align-items: center; padding: 4px; border-bottom: 1px solid var(--db--colors-gray004); background-color: rgb(13, 17, 23);"><button type="button" class="db--c-dsHufW" style="box-sizing: inherit; display: flex; gap: 4px; border: none; cursor: pointer; height: 18px; padding-right: 6px; background-color: transparent; color: var(--db--colors-gray001);"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 16 16" class="db--c-bHwuwj"><path stroke="currentColor" stroke-width="1.5" d="M13.016 10.331l1.382 2.57-2.482 1.535M11.084 9.814l-2.482 1.535 1.382 2.57"></path><path stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M11.5 8V6a1 1 0 00-1-1H5a1 1 0 00-1 1v5.5a1 1 0 001 1h1"></path><path stroke="currentColor" stroke-width="1.5" d="M9.5 5V3.5a1 1 0 00-1-1h-6a1 1 0 00-1 1v6a1 1 0 001 1H4"></path></svg>Copy snippet</button></div><code class="PJLV PJLV-igIoyjz-css language-python hljs" style="box-sizing: inherit; width: 393.96px; font-size: var(--db--fontSizes-1); border-radius: 6px; overflow-x: auto; padding: 1em; color: rgb(201, 209, 217); background: rgb(13, 17, 23); display: block;"><span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># src/app/apis/ws_crypto/__init__.py</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> asyncio
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> json
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> logging
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> threading
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> time
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">from</span> typing <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">List</span>, <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Dict</span>, <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Any</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">from</span> datetime <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> datetime

<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> websocket <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># websocket-client library</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">from</span> fastapi <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">import</span> APIRouter, WebSocket, WebSocketDisconnect

logger = logging.getLogger(__name__)
<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Avoid duplicate handlers</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> logger.hasHandlers():
    logging.basicConfig(level=logging.INFO, <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">format</span>=<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>)

router = APIRouter()

<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- Configuration ---</span>
<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Use the correct Advanced Trade WebSocket URL</span>
COINBASE_WS_URL = <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"wss://advanced-trade-ws.coinbase.com"</span>
<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Define crypto pairs - consider making this configurable</span>
CRYPTO_PAIRS = [<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"BTC-USD"</span>, <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"ETH-USD"</span>, <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"SOL-USD"</span>, <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"DOGE-USD"</span>, <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"ADA-USD"</span>] <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Example pairs</span>
SUBSCRIPTION_MSG = {
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"type"</span>: <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"subscribe"</span>,
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"product_ids"</span>: CRYPTO_PAIRS,
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"channels"</span>: [<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"ticker"</span>] <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Using 'ticker' channel for price updates (common for price streams)</span>
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Note: Advanced Trade API might require API key authentication for some channels/features</span>
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># If authentication is needed, it requires generating a signature based on timestamp, method, path, body</span>
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># "api_key": db.secrets.get("COINBASE_API_KEY"), # Example if needed</span>
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># "timestamp": str(int(time.time())), # Example if needed</span>
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># "signature": "GENERATED_SIGNATURE", # Example if needed</span>
}

<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- Global Variable for Main Event Loop ---</span>
main_event_loop = <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>

<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- Connection Manager (Same pattern as ws_stocks) ---</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">class</span> <span class="hljs-title class_" style="box-sizing: inherit; color: rgb(210, 168, 255);">ConnectionManager</span>:
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">__init__</span>(<span class="hljs-params" style="box-sizing: inherit;">self</span>):
        self.active_connections: <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">List</span>[WebSocket] = []
        self.lock = asyncio.Lock()

    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">async</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">connect</span>(<span class="hljs-params" style="box-sizing: inherit;">self, websocket: WebSocket</span>):
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">await</span> websocket.accept()
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">async</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">with</span> self.lock:
            self.active_connections.append(websocket)
        logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Crypto client connected: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{websocket.client}</span>. Total: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">len</span>(self.active_connections)}</span>"</span>)

    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">async</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">disconnect</span>(<span class="hljs-params" style="box-sizing: inherit;">self, websocket: WebSocket</span>):
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">async</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">with</span> self.lock:
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">try</span>:
                self.active_connections.remove(websocket)
                logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Crypto client disconnected: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{websocket.client}</span>. Total: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">len</span>(self.active_connections)}</span>"</span>)
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> ValueError:
                logger.debug(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Attempted to disconnect an already removed crypto client: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{websocket.client}</span>"</span>)
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> Exception <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> e:
                logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Error during crypto client disconnection <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{websocket.client}</span>: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{e}</span>"</span>)

    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">async</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">broadcast_json</span>(<span class="hljs-params" style="box-sizing: inherit;">self, data: <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Dict</span>[<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">str</span>, <span class="hljs-type" style="box-sizing: inherit; color: rgb(255, 123, 114);">Any</span>]</span>):
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">async</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">with</span> self.lock:
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> self.active_connections:
                <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">return</span>

            tasks = [conn.send_json(data) <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">for</span> conn <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">in</span> self.active_connections]
            results = <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">await</span> asyncio.gather(*tasks, return_exceptions=<span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">True</span>)

            disconnected_clients = []
            active_conn_copy = self.active_connections[:]

            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">for</span> i, result <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">in</span> <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">enumerate</span>(results):
                 <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">isinstance</span>(result, Exception):
                      <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> i &lt; <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">len</span>(active_conn_copy):
                           client_to_remove = active_conn_copy[i]
                           logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Failed to send message to crypto client <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{client_to_remove.client}</span>: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{result}</span>. Marking for removal."</span>)
                           <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> client_to_remove <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">in</span> self.active_connections:
                                disconnected_clients.append(client_to_remove)
                      <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span>:
                           logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Index out of range during crypto broadcast error handling. Index: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{i}</span>, Connections: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">len</span>(self.active_connections)}</span>"</span>)

            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> disconnected_clients:
                 <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">for</span> client <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">in</span> disconnected_clients:
                      <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">await</span> self.disconnect(client)
                 logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Removed <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{<span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">len</span>(disconnected_clients)}</span> crypto clients after broadcast errors."</span>)

manager = ConnectionManager()

<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- Coinbase WebSocket Background Thread ---</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">coinbase_websocket_client_thread</span>(<span class="hljs-params" style="box-sizing: inherit;">loop: asyncio.AbstractEventLoop</span>):
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"""Connects to Coinbase, runs loop, passes main loop to callbacks."""</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">global</span> main_event_loop
    main_event_loop = loop
    logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Coinbase thread started, using event loop: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{loop}</span>"</span>)

    ws_app = <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">while</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">True</span>:
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">try</span>:
            logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Connecting to Coinbase WebSocket at <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{COINBASE_WS_URL}</span>..."</span>)
            on_message_with_loop = <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">lambda</span> ws, msg: on_coinbase_message(ws, msg, loop)

            ws_app = websocket.WebSocketApp(COINBASE_WS_URL,
                                          on_open=on_coinbase_open,
                                          on_message=on_message_with_loop,
                                          on_error=on_coinbase_error,
                                          on_close=on_coinbase_close)
            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Use run_forever with ping/pong handling or reconnection strategy</span>
            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Coinbase typically requires client-side pings or relies on server messages</span>
            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># run_forever has basic reconnect logic if specified</span>
            ws_app.run_forever(ping_interval=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">30</span>, ping_timeout=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">10</span>, reconnect=<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">5</span>) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Added reconnect=5</span>

        <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Specific exceptions first</span>
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> websocket.WebSocketTimeoutException:
             logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Coinbase WebSocket timed out. Attempting reconnect via run_forever..."</span>)
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> websocket.WebSocketConnectionClosedException:
             logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Coinbase WebSocket connection closed unexpectedly. Attempting reconnect via run_forever..."</span>)
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> websocket.WebSocketException <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> e:
            logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Coinbase WebSocketException: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{e}</span>. Attempting reconnect via run_forever..."</span>)
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> Exception <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> e:
            logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Unexpected error in Coinbase client loop: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{e}</span>. Attempting restart..."</span>, exc_info=<span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">True</span>)

        <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Explicit delay before restarting loop</span>
        logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Coinbase run_forever loop ended. Waiting 10 seconds before restarting connection attempt."</span>)
        time.sleep(<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">10</span>)


<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">on_coinbase_message</span>(<span class="hljs-params" style="box-sizing: inherit;">ws, message, loop: asyncio.AbstractEventLoop</span>):
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"""Callback for handling messages from Coinbase."""</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">try</span>:
        data = json.loads(message)
        <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># logger.debug(f"Raw Coinbase message: {data}") # Log raw message</span>

        <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Coinbase Advanced Trade WS uses a nested structure, often with 'events'</span>
        msg_type = data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"channel"</span>) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Channel often indicates the type of data</span>
        events = data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"events"</span>, [])

        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> msg_type == <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"subscriptions"</span>:
            logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Coinbase subscription confirmation: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{data}</span>"</span>)
            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Check if subscription was successful for our products/channels</span>
            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Example: Check if 'ticker' channel is in data['channels'] for expected product_ids</span>

        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">elif</span> msg_type == <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"ticker"</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">and</span> events:
             <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">for</span> event_batch <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">in</span> events: <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Events is often a list of batches</span>
                 tickers = event_batch.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"tickers"</span>, [])
                 <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">for</span> ticker_data <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">in</span> tickers:
                     <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> ticker_data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"type"</span>) == <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"ticker"</span>: <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Confirm event type within batch</span>
                         symbol = ticker_data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"product_id"</span>)
                         price_str = ticker_data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"price"</span>) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Price is usually a string</span>
                         <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Timestamp might be in the outer message or event batch header</span>
                         timestamp_str = data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"timestamp"</span>) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># ISO 8601 format like '2023-02-09T20:32:54.765258Z'</span>

                         <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> symbol <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">and</span> price_str <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">and</span> timestamp_str:
                             <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">try</span>:
                                 price = <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">float</span>(price_str)
                                 <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Parse timestamp and convert to milliseconds since epoch (UTC)</span>
                                 dt_obj = datetime.fromisoformat(timestamp_str.replace(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'Z'</span>, <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'+00:00'</span>))
                                 timestamp_ms = <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">int</span>(dt_obj.timestamp() * <span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">1000</span>)

                                 <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># logger.debug(f"Crypto Ticker: {symbol} Price: {price} Time: {timestamp_ms}")</span>
                                 <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Prepare data for broadcasting</span>
                                 broadcast_data = {
                                     <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"type"</span>: <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"CryptoUpdate"</span>, <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Custom type for frontend</span>
                                     <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"sym"</span>: symbol,
                                     <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"p"</span>: price,
                                     <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"t"</span>: timestamp_ms
                                 }
                                 <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Schedule broadcast on the main event loop</span>
                                 <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> loop <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">and</span> loop.is_running():
                                     asyncio.run_coroutine_threadsafe(manager.broadcast_json(broadcast_data), loop)
                                 <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span>:
                                     logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Main event loop not available or not running for crypto broadcast."</span>)

                             <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> ValueError:
                                 logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Could not convert crypto price '<span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{price_str}</span>' to float for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span>."</span>)
                             <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> Exception <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> parse_err:
                                 logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Error parsing timestamp or processing ticker data for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{symbol}</span>: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{parse_err}</span> - Data: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{ticker_data}</span>"</span>)
                         <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span>:
                             logger.debug(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Ignoring incomplete ticker data: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{ticker_data}</span>"</span>)
        <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Handle other message types ('heartbeat', 'status', etc.) if necessary</span>
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">elif</span> msg_type == <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"heartbeats"</span>:
             <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># logger.debug(f"Coinbase heartbeat received: {data}")</span>
             <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">pass</span> <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Usually just confirms connection is alive</span>
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">elif</span> data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"type"</span>) == <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"error"</span>:
            logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Coinbase WebSocket Error Message: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'message'</span>)}</span> Reason: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{data.get(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">'reason'</span>)}</span>"</span>)

    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> json.JSONDecodeError:
        logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Failed to decode JSON from Coinbase: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{message}</span>"</span>)
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> Exception <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> e:
        logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Error processing Coinbase message: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{e}</span>"</span>, exc_info=<span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">True</span>)

<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">on_coinbase_error</span>(<span class="hljs-params" style="box-sizing: inherit;">ws, error</span>):
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"""Callback for WebSocket errors."""</span>
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># websocket-client might sometimes pass Exceptions here instead of strings</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> <span class="hljs-built_in" style="box-sizing: inherit; color: rgb(255, 166, 87);">isinstance</span>(error, Exception):
         logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Coinbase WebSocket Error: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{error}</span>"</span>, exc_info=<span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">True</span>)
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span>:
         logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Coinbase WebSocket Error: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{error}</span>"</span>)


<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">on_coinbase_close</span>(<span class="hljs-params" style="box-sizing: inherit;">ws, close_status_code, close_msg</span>):
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"""Callback when the WebSocket connection is closed."""</span>
    logger.warning(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Coinbase WebSocket connection closed. Code: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{close_status_code}</span>, Msg: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{close_msg}</span>"</span>)
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Reconnection handled by run_forever(reconnect=...)</span>

<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">on_coinbase_open</span>(<span class="hljs-params" style="box-sizing: inherit;">ws</span>):
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"""Callback when the WebSocket connection is opened."""</span>
    logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Coinbase WebSocket connection opened. Subscribing..."</span>)
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Send subscription message (ensure it's JSON string)</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">try</span>:
        ws.send(json.dumps(SUBSCRIPTION_MSG))
        logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Sent subscription message to Coinbase: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{SUBSCRIPTION_MSG}</span>"</span>)
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> Exception <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> e:
        logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Failed to send subscription message to Coinbase: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{e}</span>"</span>)


<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- FastAPI WebSocket Endpoint ---</span>
<span class="hljs-meta" style="box-sizing: inherit; color: rgb(121, 192, 255);">@router.websocket(<span class="hljs-params" style="box-sizing: inherit;"><span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"/ws/crypto"</span></span>)</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">async</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">websocket_endpoint_crypto</span>(<span class="hljs-params" style="box-sizing: inherit;">websocket: WebSocket</span>):
    <span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"""Handles frontend client connections for crypto data."""</span>
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">await</span> manager.connect(websocket)
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">try</span>:
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">while</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">True</span>:
            <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Keep connection open</span>
            <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">await</span> asyncio.sleep(<span class="hljs-number" style="box-sizing: inherit; color: rgb(121, 192, 255);">60</span>)
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> WebSocketDisconnect:
        logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Crypto client <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{websocket.client}</span> disconnected (WebSocketDisconnect)"</span>)
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">await</span> manager.disconnect(websocket)
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">except</span> Exception <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">as</span> e:
        logger.error(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">f"Error in crypto websocket connection for <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{websocket.client}</span>: <span class="hljs-subst" style="box-sizing: inherit; color: rgb(201, 209, 217);">{e}</span>"</span>, exc_info=<span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">True</span>)
        <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">await</span> manager.disconnect(websocket) <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Ensure disconnect on error</span>

<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- Startup Event ---</span>
_crypto_thread = <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span>

<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">start_crypto_websocket_thread</span>():
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">global</span> _crypto_thread
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># Add check if API key is needed and not present? (Currently no auth used)</span>
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># if not db.secrets.get("COINBASE_API_KEY"):</span>
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);">#     logger.warning("COINBASE_API_KEY secret not set. Crypto WebSocket might fail if auth is required.")</span>
    <span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);">#     # Decide whether to return or proceed without auth</span>

    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">if</span> _crypto_thread <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">is</span> <span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">None</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">or</span> <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">not</span> _crypto_thread.is_alive():
        loop = asyncio.get_event_loop()
        _crypto_thread = threading.Thread(target=coinbase_websocket_client_thread, args=(loop,), daemon=<span class="hljs-literal" style="box-sizing: inherit; color: rgb(121, 192, 255);">True</span>)
        _crypto_thread.start()
        logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Coinbase WebSocket client thread started."</span>)
    <span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">else</span>:
        logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Coinbase WebSocket client thread already running."</span>)

<span class="hljs-comment" style="box-sizing: inherit; color: rgb(139, 148, 158);"># --- Optional Shutdown ---</span>
<span class="hljs-keyword" style="box-sizing: inherit; color: rgb(255, 123, 114);">def</span> <span class="hljs-title function_" style="box-sizing: inherit; color: rgb(210, 168, 255);">stop_crypto_websocket_thread</span>():
    logger.info(<span class="hljs-string" style="box-sizing: inherit; color: rgb(165, 214, 255);">"Crypto WebSocket thread shutdown requested (best effort)."</span>)</code></pre>
    </div>
    </pre><!--EndFragment-->
</body>

</html>